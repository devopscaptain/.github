name: Create Team
on:
  pull_request:
    types: [closed]
    paths:
      - 'team-name.txt'

jobs:
  create_team:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Team Details
        id: extract
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          TEAM_NAME=$(cat team-name.txt)

          PRIVACY=$(echo "$PR_BODY" | sed -n 's/^.*Visibility:\s*\(\w*\).*$/\1/p' | tr '[:upper:]' '[:lower:]')
          DESCRIPTION=$(echo "$PR_BODY" | sed -n 's/^.*Purpose:\s*\(.*\).*$/\1/p')
          MAINTAINERS=$(echo "$PR_BODY" | sed -n 's/^.*Maintainers:\s*\(.*\).*$/\1/p')

          echo "TEAM_NAME=$TEAM_NAME" >> $GITHUB_ENV
          echo "PRIVACY=${PRIVACY:-secret}" >> $GITHUB_ENV
          echo "DESCRIPTION='${DESCRIPTION:-Team created via automation}'" >> $GITHUB_ENV
          echo "MAINTAINERS=${MAINTAINERS:-none}" >> $GITHUB_ENV

          # Debugging output
          echo "Extracted values:"
          echo "Team: $TEAM_NAME"
          echo "Privacy: $PRIVACY"
          echo "Description: $DESCRIPTION"
          echo "Maintainers: $MAINTAINERS"

      - name: Create GitHub Team
        uses: actions/github-script@v6
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            try {
              const teamSlug = process.env.TEAM_NAME.toLowerCase().replace(/\s+/g, '-');

              const { data: team } = await github.rest.teams.create({
                org: context.repo.owner,
                name: process.env.TEAM_NAME,
                slug: teamSlug,
                description: process.env.DESCRIPTION,
                privacy: process.env.PRIVACY,
              });

              if (process.env.MAINTAINERS && process.env.MAINTAINERS !== 'none') {
                const maintainers = process.env.MAINTAINERS.split(',');
                for (const user of maintainers) {
                  await github.rest.teams.addOrUpdateMembershipForUserInOrg({
                    org: context.repo.owner,
                    team_slug: team.slug,
                    username: user.trim(),
                    role: 'maintainer'
                  });
                }
              }

              await github.rest.issues.createComment({
                issue_number: ${{ github.event.pull_request.number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `✅ Team **${team.name}** created!\n\n` +
                      `- **Visibility**: ${process.env.PRIVACY}\n` +
                      `- **Description**: ${process.env.DESCRIPTION}\n` +
                      (process.env.MAINTAINERS !== 'none' ? 
                       `- **Maintainers**: ${process.env.MAINTAINERS}` : '')
              });
            } catch (error) {
              core.setFailed(`Team creation failed: ${error}`);
              await github.rest.issues.createComment({
                issue_number: ${{ github.event.pull_request.number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `❌ Failed to create team: ${error.message}`
              });
            }
